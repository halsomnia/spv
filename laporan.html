<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Dashboard Laporan</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-black: #000000;
            --success-green: #2e7d32;
            --danger-red: #d32f2f;
            --light-gray: #f9f9f9;
            --border-color: #eeeeee;
            --sidebar-width: 260px;
        }

        body {
            margin: 0; font-family: 'DM Sans', sans-serif;
            background: #f0f2f5; color: var(--primary-black);
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- HEADER MOBILE --- */
        .mobile-header {
            display: none; background: var(--primary-black); color: #fff;
            padding: 0 15px; height: 60px; align-items: center;
            position: fixed; top: 0; left: 0; right: 0; z-index: 1200;
        }

        .menu-btn { font-size: 24px; cursor: pointer; margin-right: 15px; background: none; border: none; color: white; padding: 0; }
        .header-title { font-size: 1em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: #fff; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 1000; transition: transform 0.3s ease;
        }
        .sidebar-brand { padding: 25px 20px; font-weight: 700; font-size: 1.1em; border-bottom: 1px solid var(--border-color); text-transform: uppercase; }
        .nav-tabs { display: flex; flex-direction: column; padding: 10px 0; overflow-y: auto; }
        .nav-item { padding: 15px 20px; font-size: 0.9em; font-weight: 500; color: #666; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background: #f8f9fa; color: #000; }
        .nav-item.active { background: #f0f2f5; color: var(--primary-black); font-weight: 700; border-left: 4px solid var(--primary-black); }

        /* --- CONTENT AREA --- */
        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 25px; position: relative; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .report-card {
            background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 25px; margin-bottom: 20px; max-width: 1100px; margin-left: auto; margin-right: auto;
            width: 100%; box-sizing: border-box;
        }

        .report-header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--primary-black); }
        .report-header h1 { margin: 0; font-size: 1.3em; text-transform: uppercase; }
        .subtitle { font-size: 0.85em; color: #666; margin-top: 5px; }

        .filter-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-item { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 80px; }
        .filter-item.full-width { flex: 0 0 100%; }
        .filter-label { font-size: 0.65em; font-weight: 700; color: #888; text-transform: uppercase; }
        
        select, .dropdown-btn, .search-input { padding: 9px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.85em; width: 100%; box-sizing: border-box; outline: none; }
        .dropdown-btn { display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; }

        .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 0.85em; }
        th { background: var(--primary-black); color: #fff; padding: 12px 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid var(--border-color); }
        tr:nth-child(even) { background: var(--light-gray); }
        .row-total td { background: var(--primary-black) !important; color: #fff; font-weight: 700; position: sticky; bottom: 0; z-index: 10; }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-bold { font-weight: 700; }
        .text-green { color: var(--success-green); }
        .text-red { color: var(--danger-red); }

        .dropdown-content { display: none; position: absolute; background: #fff; border: 1px solid #ccc; max-height: 250px; overflow-y: auto; z-index: 100; min-width: 180px; border-radius: 6px; margin-top: 4px; right: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 10px; display: flex; gap: 10px; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.85em; }
        .dropdown-item:hover { background: #f8f9fa; }

        .autocomplete-wrapper { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .autocomplete-item { padding: 10px; cursor: pointer; font-size: 0.85em; }
        .autocomplete-item:hover { background: #f0f2f5; }

        #menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); z-index: 1500; width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 75px 10px 20px 10px; }
            .report-card { padding: 15px 10px; border-radius: 0; box-shadow: none; }
            .report-header { display: none; }
        }

        #pin-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2500; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        .pin-box { background: #ffffff; padding: 40px 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 360px; }
        .pin-input { font-size: 2em; letter-spacing: 12px; padding: 15px; width: 100%; text-align: center; margin-bottom: 20px; border: 2px solid #eee; border-radius: 12px; outline: none; box-sizing: border-box; }
        .btn-login { display: block; width: 100%; padding: 14px; background: var(--primary-black); color: #fff; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2600; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.92); }
        .spinner-ring { width: 60px; height: 60px; border: 6px solid rgba(0, 0, 0, 0.1); border-top: 6px solid var(--primary-black); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* MODAL & PROFILE STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-box { background: #fff; width: 95%; max-width: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; background: var(--primary-black); color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        
        .profile-card { background: #f8f9fa; border-left: 4px solid var(--primary-black); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .profile-label { font-size: 0.65em; color: #888; font-weight: 700; text-transform: uppercase; }
        .profile-value { font-size: 0.85em; color: #333; font-weight: 500; margin-top: 2px; }
        .clickable-name { color: #1a73e8; cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>

    <header class="mobile-header">
        <button class="menu-btn" onclick="toggleMenu()">☰</button>
        <div class="header-title" id="mobile-title">Pencapaian Omzet</div>
    </header>

    <div id="menu-overlay" onclick="toggleMenu()"></div>

    <div id="pin-modal">
        <div class="pin-box">
            <div style="font-weight:700; font-size:1.4em; margin-bottom:20px;">Akses Terbatas</div>
            <input type="password" id="inputPin" class="pin-input" maxlength="8" placeholder="••••" inputmode="numeric">
            <button class="btn-login" onclick="handleLogin()">MASUK DASHBOARD</button>
        </div>
    </div>

    <div id="loader-overlay" style="display:none;">
        <div class="spinner-ring"></div>
        <div id="load-percent" style="font-weight:700; font-size:1.5em;">0%</div>
        <div style="color:#666;">Memproses Data...</div>
    </div>

    <div class="sidebar" id="sidebarArea">
        <div class="sidebar-brand">Laporan</div>
        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('tab-omzet', 'Pencapaian Omzet')">Omzet Target Sales</div>
            <div class="nav-item" onclick="switchTab('tab-harian', 'Penjualan Pembayaran')">Penjualan dan Pembayaran</div>
            <div class="nav-item" onclick="switchTab('tab-pelanggan', 'Penjualan Pelanggan')">Penjualan Pelanggan</div>
            <div class="nav-item" onclick="switchTab('tab-aging', 'Aging Piutang')">Aging Piutang</div>
        </div>
    </div>

    <div class="main-wrapper" id="mainWrapper" style="display:none;">
        <div class="main-content" id="mainScrollContent">
            
            <div id="tab-omzet" class="tab-pane active">
                <div class="report-card">
                    <div class="report-header"><h1>Pencapaian Omzet</h1><div class="subtitle" id="omzet-sub"></div></div>
                    <div class="filter-group">
                        <div class="filter-item"><span class="filter-label">Thn</span><select id="omzet-thn" onchange="renderOmzet()"></select></div>
                        <div class="filter-item"><span class="filter-label">Bln</span><select id="omzet-bln" onchange="renderOmzet()"></select></div>
                        <div class="filter-item"><span class="filter-label">Kat</span>
                            <div style="position:relative;">
                                <div class="dropdown-btn" onclick="toggleDrop('omzet-dropKat')"><span id="omzet-lblKat">Pilih...</span> ▼</div>
                                <div id="omzet-dropKat" class="dropdown-content"></div>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th rowspan="2">Sales</th><th rowspan="2" class="text-right">Target</th><th rowspan="2" class="text-right">Jumlah</th><th rowspan="2" class="text-center">%</th><th colspan="3" class="text-center">Kurang</th></tr>
                                <tr><th class="text-right">70%</th><th class="text-right">80%</th><th class="text-right">100%</th></tr>
                            </thead>
                            <tbody id="omzet-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-harian" class="tab-pane">
                <div class="report-card">
                    <div class="report-header"><h1>Penjualan & Pembayaran</h1><div class="subtitle" id="harian-sub"></div></div>
                    <div class="filter-group">
                        <div class="filter-item"><span class="filter-label">Thn</span><select id="harian-thn" onchange="renderHarian()"></select></div>
                        <div class="filter-item"><span class="filter-label">Bln</span><select id="harian-bln" onchange="renderHarian()"></select></div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th rowspan="2" class="text-center">Tgl</th><th colspan="2" class="text-center">Penjualan</th><th colspan="2" class="text-center">Pembayaran</th></tr>
                                <tr><th class="text-center">BDG</th><th class="text-center">CRB</th><th class="text-center">BDG</th><th class="text-center">CRB</th></tr>
                            </thead>
                            <tbody id="harian-body"></tbody>
                            <tfoot><tr class="row-total"><td>TOTAL</td><td colspan="2" class="text-right" id="harian-tJual">0</td><td colspan="2" class="text-right" id="harian-tBayar">0</td></tr></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-pelanggan" class="tab-pane">
                <div class="report-card">
                    <div class="report-header"><h1>Penjualan Pelanggan</h1></div>
                    <div class="filter-group">
                        <div class="filter-item"><span class="filter-label">Thn</span><select id="cust-thn" onchange="resetAndRender('cust')"></select></div>
                        <div class="filter-item"><span class="filter-label">Sales</span>
                            <div style="position:relative;">
                                <div class="dropdown-btn" onclick="toggleDrop('cust-dropSales')"><span id="cust-lblSales">Semua</span> ▼</div>
                                <div id="cust-dropSales" class="dropdown-content"></div>
                            </div>
                        </div>
                        <div class="filter-item"><span class="filter-label">Bln</span>
                            <div style="position:relative;">
                                <div class="dropdown-btn" onclick="toggleDrop('cust-dropBln')"><span id="cust-lblBln">Semua</span> ▼</div>
                                <div id="cust-dropBln" class="dropdown-content"></div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-item full-width autocomplete-wrapper">
                            <input type="text" id="cust-search" class="search-input" placeholder="Cari Nama Pelanggan..." autocomplete="off">
                            <div id="cust-autocomplete" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th onclick="sortCust('s')">Sales ↕</th><th onclick="sortCust('p')">Pelanggan ↕</th><th onclick="sortCust('b')">Bln ↕</th><th class="text-right" onclick="sortCust('v')">Jumlah ↕</th></tr>
                            </thead>
                            <tbody id="cust-body"></tbody>
                            <tfoot><tr class="row-total"><td colspan="3" class="text-right">GRAND TOTAL</td><td class="text-right" id="cust-total">0</td></tr></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-aging" class="tab-pane">
                <div class="report-card">
                    <div class="report-header"><h1>Aging Piutang</h1></div>
                    <div class="filter-group">
                        <div class="filter-item"><span class="filter-label">Sales</span>
                            <div style="position:relative;">
                                <div class="dropdown-btn" onclick="toggleDrop('aging-dropSales')"><span id="aging-lblSales">Semua</span> ▼</div>
                                <div id="aging-dropSales" class="dropdown-content"></div>
                            </div>
                        </div>
                        <div class="filter-item"><span class="filter-label">Umur</span>
                            <div style="position:relative;">
                                <div class="dropdown-btn" onclick="toggleDrop('aging-dropUmur')"><span id="aging-lblUmur">Semua</span> ▼</div>
                                <div id="aging-dropUmur" class="dropdown-content"></div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-item full-width autocomplete-wrapper">
                            <input type="text" id="aging-search" class="search-input" placeholder="Cari Pelanggan..." autocomplete="off">
                            <div id="aging-autocomplete" class="autocomplete-list"></div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th>Pelanggan</th><th>No Faktur</th><th class="text-center">Tgl</th><th class="text-center">Umur</th><th class="text-right">Jumlah</th></tr>
                            </thead>
                            <tbody id="aging-body"></tbody>
                            <tfoot><tr class="row-total"><td colspan="4" class="text-center">TOTAL PIUTANG</td><td class="text-right" id="aging-total">0</td></tr></tfoot>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div id="modal-title" style="font-weight:700;">Detail Pelanggan</div>
                <button onclick="document.getElementById('detail-modal').style.display='none'" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-card">
                    <div style="grid-column: span 2;">
                        <div class="profile-label">Alamat</div>
                        <div id="p-alamat" class="profile-value">-</div>
                    </div>
                    <div>
                        <div class="profile-label">Kota</div>
                        <div id="p-kota" class="profile-value">-</div>
                    </div>
                    <div>
                        <div class="profile-label">Day</div>
                        <div id="p-day" class="profile-value" style="color:#d32f2f; font-weight:700;">-</div>
                    </div>
                    <div>
                        <div class="profile-label">SPV</div>
                        <div id="p-spv" class="profile-value">-</div>
                    </div>
                    <div>
                        <div class="profile-label">Sales</div>
                        <div id="p-sales" class="profile-value">-</div>
                    </div>
                </div>
                <div class="table-wrapper" id="modal-table-content"></div>
            </div>
        </div>
    </div>

<script>
    /* --- CONFIG & DATA --- */
    const API_URL = "https://script.google.com/macros/s/AKfycbxdM5xVkrpd9WqqK6Ffn42_fNdbCz2vLMcIu0b0jxpO9bnqJDWUfRNM4z-Eyst3HFa7/exec";
    const DATA_STORE = { jual: [], bayar: [], target: [], aging: [], masterPelanggan: [] };
    const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    let limitCust = 50, limitAging = 50, gapLoad = 50;
    let custNames = [], agingNames = [], custSortCol = 's', custSortDir = 1;

    /* --- AUTH & LOAD --- */
    async function handleLogin() {
        const pin = document.getElementById('inputPin').value;
        const loader = document.getElementById('loader-overlay');
        const pctText = document.getElementById('load-percent');
        
        loader.style.display = 'flex';
        document.getElementById('pin-modal').style.display = 'none';
        
        let progress = 0;
        const timer = setInterval(() => { if(progress < 90) { progress += 5; pctText.innerText = progress + "%"; } }, 100);

        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            
            if (pin !== String(data.pin)) {
                alert("PIN SALAH!");
                location.reload();
                return;
            }

            DATA_STORE.jual = data.penjualan;
            DATA_STORE.bayar = data.pembayaran;
            DATA_STORE.target = data.target;
            DATA_STORE.aging = data.aging;
            DATA_STORE.masterPelanggan = data.masterPelanggan;

            custNames = [...new Set(DATA_STORE.jual.map(d => d.Pelanggan).filter(Boolean))].sort();
            agingNames = [...new Set(DATA_STORE.aging.map(d => d.PELANGGAN).filter(Boolean))].sort();

            initAll();
            clearInterval(timer);
            pctText.innerText = "100%";
            setTimeout(() => {
                loader.style.display = 'none';
                document.getElementById('mainWrapper').style.display = 'flex';
            }, 500);
        } catch (e) {
            alert("Gagal memuat data: " + e.message);
            location.reload();
        }
    }

    /* --- INITIALIZATION --- */
    function initAll() {
        initOmzet();
        initHarian();
        initCust();
        initAging();

        document.getElementById('mainScrollContent').onscroll = function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                const active = document.querySelector('.tab-pane.active').id;
                if(active === 'tab-pelanggan') { limitCust += gapLoad; renderCust(); }
                if(active === 'tab-aging') { limitAging += gapLoad; renderAging(); }
            }
        };

        document.getElementById('cust-search').oninput = function() { resetAndRender('cust'); showAuto('cust', this.value); };
        document.getElementById('aging-search').oninput = function() { resetAndRender('aging'); showAuto('aging', this.value); };
    }

    /* --- TAB: OMZET --- */
    function initOmzet() {
        const yrs = [...new Set(DATA_STORE.jual.map(d => String(d.Tahun)))].sort((a,b)=>b-a);
        const blns = [...new Set(DATA_STORE.jual.map(d => d.Bulan))].sort((a,b) => MONTHS.findIndex(m=>a.includes(m)) - MONTHS.findIndex(m=>b.includes(m)));
        const kats = [...new Set(DATA_STORE.jual.map(d => d.Kategori))].sort();

        fillSel('omzet-thn', yrs);
        fillSel('omzet-bln', blns);
        populateCheck('omzet-dropKat', kats, 'chk-o-kat', renderOmzet, ["DISTRIBUSI"]);
        
        setDef('omzet-thn', 'omzet-bln', blns);
        renderOmzet();
    }

    function renderOmzet() {
        const thn = document.getElementById('omzet-thn').value;
        const bln = document.getElementById('omzet-bln').value;
        const kats = getChecks('chk-o-kat');
        
        document.getElementById('omzet-lblKat').innerText = kats.length + " Kat";
        document.getElementById('omzet-sub').innerText = `${bln} ${thn}`;

        const realMap = {};
        DATA_STORE.jual.filter(d => String(d.Tahun) === thn && d.Bulan === bln && kats.includes(d.Kategori))
            .forEach(d => realMap[d.Sales] = (realMap[d.Sales]||0) + (parseFloat(d["Jumlah (Inc)"])||0));

        const groups = {};
        DATA_STORE.target.forEach(t => {
            if(!groups[t.Spv]) groups[t.Spv] = [];
            groups[t.Spv].push({ name: t.Sales, tgt: parseFloat(t.Target)||0 });
        });

        let html = "";
        Object.keys(groups).forEach(spv => {
            let sT = 0, sR = 0, rows = "";
            groups[spv].forEach(s => {
                const r = realMap[s.name]||0; sT += s.tgt; sR += r;
                const p = s.tgt > 0 ? Math.round((r/s.tgt)*100) : 0;
                rows += `<tr><td>${s.name}</td><td class="text-right">${fmt(s.tgt)}</td><td class="text-right">${fmt(r)}</td><td class="text-center text-bold ${p>=70?'text-green':''}">${p}%</td><td class="text-right">${df(s.tgt*0.7-r)}</td><td class="text-right">${df(s.tgt*0.8-r)}</td><td class="text-right">${df(s.tgt-r)}</td></tr>`;
            });
            const pS = sT > 0 ? Math.round(sR/sT*100) : 0;
            html += rows + `<tr class="row-total"><td>${spv}</td><td class="text-right">${fmt(sT)}</td><td class="text-right">${fmt(sR)}</td><td class="text-center">${pS}%</td><td class="text-right">${df(sT*0.7-sR)}</td><td class="text-right">${df(sT*0.8-sR)}</td><td class="text-right">${df(sT-sR)}</td></tr>`;
        });
        document.getElementById('omzet-body').innerHTML = html;
    }

    /* --- TAB: HARIAN --- */
    function initHarian() {
        const yrs = [...new Set(DATA_STORE.jual.map(d => String(d.Tahun)))].sort((a,b)=>b-a);
        const blns = [...new Set(DATA_STORE.jual.map(d => d.Bulan))].sort((a,b) => MONTHS.findIndex(m=>a.includes(m)) - MONTHS.findIndex(m=>b.includes(m)));
        fillSel('harian-thn', yrs);
        fillSel('harian-bln', blns);
        setDef('harian-thn', 'harian-bln', blns);
        renderHarian();
    }

    function renderHarian() {
        const thn = document.getElementById('harian-thn').value;
        const bln = document.getElementById('harian-bln').value;
        document.getElementById('harian-sub').innerText = `${bln} ${thn}`;
        
        const map = {};
        DATA_STORE.jual.filter(d => String(d.Tahun) === thn && d.Bulan === bln).forEach(d => {
            const k = new Date(d["Tgl Faktur"]).toDateString();
            if(!map[k]) map[k] = { jB:0, jC:0, bB:0, bC:0 };
            if(d.Gudang === "BANDUNG") map[k].jB += (parseFloat(d["Jumlah (Inc)"])||0); else map[k].jC += (parseFloat(d["Jumlah (Inc)"])||0);
        });
        DATA_STORE.bayar.filter(d => String(d.Tahun) === thn && d.Bulan === bln).forEach(d => {
            const k = new Date(d["Tanggal"]).toDateString();
            if(!map[k]) map[k] = { jB:0, jC:0, bB:0, bC:0 };
            if(d.Gudang === "BANDUNG") map[k].bB += (parseFloat(d["Jumlah Bayar"])||0); else map[k].bC += (parseFloat(d["Jumlah Bayar"])||0);
        });

        let h = "", tJ = 0, tB = 0;
        Object.keys(map).sort((a,b)=>new Date(a)-new Date(b)).forEach(k => {
            const d = map[k], dt = new Date(k); tJ += (d.jB+d.jC); tB += (d.bB+d.bC);
            h += `<tr><td class="text-center">${dt.getDate()}-${MONTHS[dt.getMonth()]}</td><td class="text-right">${fmt(d.jB)}</td><td class="text-right">${fmt(d.jC)}</td><td class="text-right text-green">${fmt(d.bB)}</td><td class="text-right text-green">${fmt(d.bC)}</td></tr>`;
        });
        document.getElementById('harian-body').innerHTML = h;
        document.getElementById('harian-tJual').innerText = fmt(tJ);
        document.getElementById('harian-tBayar').innerText = fmt(tB);
    }

    /* --- TAB: CUST & AGING --- */
    function initCust() {
        const sls = [...new Set(DATA_STORE.jual.map(d => d.Sales))].sort();
        const blns = [...new Set(DATA_STORE.jual.map(d => d.Bulan))].sort((a,b) => MONTHS.findIndex(m=>a.includes(m)) - MONTHS.findIndex(m=>b.includes(m)));
        fillSel('cust-thn', [...new Set(DATA_STORE.jual.map(d => String(d.Tahun)))].sort((a,b)=>b-a));
        populateCheck('cust-dropSales', sls, 'chk-c-sls', () => resetAndRender('cust'));
        populateCheck('cust-dropBln', blns, 'chk-c-bln', () => resetAndRender('cust'));
        renderCust();
    }

    function renderCust() {
        const thn = document.getElementById('cust-thn').value, s = document.getElementById('cust-search').value.toLowerCase();
        const sls = getChecks('chk-c-sls'), blns = getChecks('chk-c-bln');
        
        document.getElementById('cust-lblSales').innerText = sls.length + " Sls";
        document.getElementById('cust-lblBln').innerText = blns.length + " Bln";

        const filtered = DATA_STORE.jual.filter(d => String(d.Tahun) === thn && sls.includes(d.Sales) && blns.includes(d.Bulan) && (d.Pelanggan||"").toLowerCase().includes(s));
        const group = {}; let grand = 0;
        filtered.forEach(d => {
            const k = d.Pelanggan + d.Bulan;
            if(!group[k]) group[k] = { s:d.Sales, p:d.Pelanggan, b:d.Bulan, v:0 };
            const v = parseFloat(d["Jumlah (Inc)"])||0; group[k].v += v; grand += v;
        });

        const arr = Object.values(group).sort((a,b) => {
            if(custSortCol === 'v') return (a.v - b.v) * custSortDir;
            return a[custSortCol].localeCompare(b[custSortCol]) * custSortDir;
        });

        document.getElementById('cust-body').innerHTML = arr.slice(0, limitCust).map(i => `<tr><td>${i.s}</td><td>${i.p}</td><td>${i.b}</td><td class="text-right">${fmt(i.v)}</td></tr>`).join('');
        document.getElementById('cust-total').innerText = fmt(grand);
    }

    function initAging() {
        const sls = [...new Set(DATA_STORE.aging.map(d => d.SALES))].sort();
        populateCheck('aging-dropSales', sls, 'chk-a-sls', () => resetAndRender('aging'));
        populateCheck('aging-dropUmur', ["1-30","31-60","61-90","91-120","121-150",">150"], 'chk-a-grp', () => resetAndRender('aging'));
        renderAging();
    }

    function renderAging() {
        const s = document.getElementById('aging-search').value.toLowerCase(), sls = getChecks('chk-a-sls'), grps = getChecks('chk-a-grp');
        document.getElementById('aging-lblSales').innerText = sls.length + " Sls";
        document.getElementById('aging-lblUmur').innerText = grps.length + " Grp";

        const filtered = DATA_STORE.aging
		.filter(d => sls.includes(d.SALES) && grps.includes(d["UMUR GRUP"]) && (d.PELANGGAN||"").toLowerCase().includes(s))
		.sort((a, b) => {
        const nameA = (a.PELANGGAN || "").toLowerCase();
        const nameB = (b.PELANGGAN || "").toLowerCase();
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return (parseInt(b.UMUR) || 0) - (parseInt(a.UMUR) || 0);
		});
				
        let total = 0; filtered.forEach(d => total += (parseFloat(d.JUMLAH)||0));
        
        document.getElementById('aging-body').innerHTML = filtered.slice(0, limitAging).map(d => {
            const u = parseInt(d.UMUR)||0;
            return `<tr><td class="clickable-name" onclick="showDetail('${d.PELANGGAN}')">${d.PELANGGAN}</td><td>${d["NO FAKTUR"]||"-"}</td><td class="text-center">${fd(d["TGL FAKTUR"])}</td><td class="text-center ${u>=120?'text-red text-bold':''}">${u}</td><td class="text-right">${fmt(d.JUMLAH)}</td></tr>`;
        }).join('');
        document.getElementById('aging-total').innerText = fmt(total);
    }

	/* --- DETAIL POPUP LOGIC --- */
	function showDetail(nama) {
		// 1. Mencari profil di masterPelanggan (Data dari Sheet6)
		const profil = DATA_STORE.masterPelanggan.find(p => p.Pelanggan === nama);
		
		// 2. Mengisi UI Modal dengan data dari masterPelanggan
		document.getElementById('p-alamat').innerText = profil ? (profil.Alamat || "-") : "-";
		document.getElementById('p-kota').innerText = profil ? (profil.Kota || "-") : "-";
		document.getElementById('p-day').innerText = profil ? (profil.Day || "-") : "-";
		
		// Mengambil SPV (Kolom E) dan Sales (Kolom D) dari Sheet6
		document.getElementById('p-spv').innerText = profil ? (profil.SPV || "-") : "-";
		document.getElementById('p-sales').innerText = profil ? (profil.Sales || "-") : "-";

		// 3. Menampilkan daftar faktur piutang (Data dari Sheet Aging)
		const det = DATA_STORE.aging.filter(d => d.PELANGGAN === nama);
		let total = 0, html = `<table><thead><tr><th>No Faktur</th><th class="text-center">Tgl</th><th class="text-right">Jumlah</th></tr></thead><tbody>`;
		
		det.forEach(d => {
			total += (parseFloat(d.JUMLAH) || 0);
			html += `<tr><td>${d["NO FAKTUR"] || "-"}</td><td class="text-center">${fd(d["TGL FAKTUR"])}</td><td class="text-right">${fmt(d.JUMLAH)}</td></tr>`;
		});

		html += `</tbody><tfoot><tr class="row-total"><td colspan="2">TOTAL PIUTANG</td><td class="text-right">${fmt(total)}</td></tr></tfoot></table>`;
		
		document.getElementById('modal-title').innerText = nama;
		document.getElementById('modal-table-content').innerHTML = html;
		document.getElementById('detail-modal').style.display = 'flex';
	}

    /* --- UTILS & UI --- */
    function populateCheck(id, items, cls, cb, exclude = []) {
        const d = document.getElementById(id); d.innerHTML = "";
        const all = document.createElement('div');
        all.className = 'dropdown-item'; all.style.fontWeight = 'bold'; all.innerText = "Pilih Semua";
        all.onclick = (e) => { e.stopPropagation(); toggleAll(cls, cb); };
        d.appendChild(all);
        items.forEach(i => {
            const row = document.createElement('div');
            row.className = 'dropdown-item';
            row.innerHTML = `<input type="checkbox" class="${cls}" value="${i}" ${!exclude.includes(i)?'checked':''}> ${i}`;
            row.onclick = (e) => {
                e.stopPropagation();
                const input = row.querySelector('input');
                if(e.target !== input) input.checked = !input.checked;
                cb();
            };
            d.appendChild(row);
        });
    }

    function toggleAll(cls, cb) {
        const ins = document.querySelectorAll('.'+cls);
        const target = !Array.from(ins).every(i => i.checked);
        ins.forEach(i => i.checked = target);
        cb();
    }

    function getChecks(cls) { return Array.from(document.querySelectorAll('.'+cls+':checked')).map(i => i.value); }
    function fmt(n) { return Math.round(n||0).toLocaleString('id-ID'); }
    function df(n) { return n > 0 ? fmt(n) : '-'; }
    function fd(s) { if(!s || s === "(blank)") return "-"; const d = new Date(s); return isNaN(d) ? s : `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`; }
    function fillSel(id, arr) { const s = document.getElementById(id); s.innerHTML = ""; arr.forEach(v => s.innerHTML += `<option value="${v}">${v}</option>`); }
    function setDef(idT, idB, blns) { const now = new Date(); document.getElementById(idT).value = now.getFullYear(); const m = blns.find(x => x.includes(MONTHS[now.getMonth()])); if(m) document.getElementById(idB).value = m; }
    function resetAndRender(t) { if(t==='cust') { limitCust=50; renderCust(); } else { limitAging=50; renderAging(); } }
    
    function toggleDrop(id) { 
        const el = document.getElementById(id); 
        const isShow = el.classList.contains('show');
        document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        if(!isShow) el.classList.add('show');
    }

    function switchTab(id, title) {
        document.querySelectorAll('.tab-pane, .nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        Array.from(document.querySelectorAll('.nav-item')).find(i => i.innerText === title).classList.add('active');
        document.getElementById('mobile-title').innerText = title;
        if(window.innerWidth <= 768) toggleMenu();
    }

    function toggleMenu() {
        const s = document.getElementById('sidebarArea');
        const o = document.getElementById('menu-overlay');
        s.classList.toggle('open');
        o.style.display = s.classList.contains('open') ? 'block' : 'none';
    }

    function showAuto(type, q) {
        const list = document.getElementById(type+'-autocomplete'), names = type==='cust'?custNames:agingNames;
        list.innerHTML = ""; if(!q) { list.style.display='none'; return; }
        const matches = names.filter(n => n.toLowerCase().includes(q.toLowerCase())).slice(0,10);
        if(!matches.length) { list.style.display='none'; return; }
        matches.forEach(m => {
            const div = document.createElement('div'); div.className='autocomplete-item'; div.innerText=m;
            div.onclick = () => { document.getElementById(type+'-search').value = m; list.style.display='none'; resetAndRender(type); };
            list.appendChild(div);
        });
        list.style.display='block';
    }

    window.onclick = (e) => {
        if(!e.target.closest('.dropdown-btn') && !e.target.closest('.dropdown-content')) document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        if(!e.target.closest('.autocomplete-wrapper')) document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display='none');
    };
    
    function sortCust(col) { if(custSortCol === col) custSortDir *= -1; else { custSortCol = col; custSortDir = 1; } renderCust(); }
</script>
</body>
</html>
