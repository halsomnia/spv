<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Laporan Pencapaian Omzet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-black: #000000;
            --success-green: #2e7d32;
            --border-color: #dddddd;
        }

        body {
            margin: 0; font-family: 'DM Sans', sans-serif;
            background: #f4f4f4; color: var(--primary-black);
            padding: 5px; display: flex; flex-direction: column; align-items: center;
        }

        .container {
            width: fit-content; 
            min-width: 320px; max-width: 98%;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 12px;
            overflow: hidden; margin-bottom: 20px;
        }

        #capture-area { padding: 12px; background: white; width: fit-content; }

        .header-title {
            background: var(--primary-black); color: #ffffff;
            padding: 12px 10px; margin: -12px -12px 10px -12px;
            text-align: center;
        }
        .header-title h1 { margin: 0; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; }
        .periode-label { font-size: 0.7rem; opacity: 0.8; margin-top: 2px; }

        .filter-group { 
            display: flex; gap: 4px; margin-bottom: 10px; 
            justify-content: center; align-items: flex-end;
        }
        .filter-item { display: flex; flex-direction: column; gap: 1px; }
        .filter-item label { font-size: 0.55em; font-weight: 700; color: #888; }
        
        select, .multiselect-btn {
            padding: 4px 8px; border: 1.2px solid var(--primary-black); border-radius: 4px;
            font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.7em;
            outline: none; background: white; height: 28px;
            box-sizing: border-box;
            min-width: 85px;
        }

        .table-wrapper { 
            width: 100%; 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: none; 
        }
        
        table { 
            width: 100%;
            border-collapse: collapse; 
            margin: 0 auto;
            white-space: nowrap; 
        }
        
        thead th { 
            background: var(--primary-black); color: #ffffff; 
            font-size: 0.6em; text-transform: uppercase; 
            padding: 6px 10px; border: 1px solid #333;
        }

        tbody td { 
            padding: 5px 10px; 
            border: 1px solid var(--border-color); 
            font-size: 0.68em; 
            line-height: 1.2;
        }
        
        .spv-total-row td { 
            background: var(--primary-black) !important; 
            color: #ffffff !important; 
            font-weight: 700; 
            border: 1px solid var(--primary-black);
            padding: 6px 10px;
        }

        .spacer-row td { height: 12px; background: #ffffff !important; border: none !important; }
        .first-in-group td { border-top: 1px solid var(--border-color); }

        .text-right { text-align: right; font-family: 'DM Sans', monospace; }
        .text-center { text-align: center; }
        .pct-achieved { color: var(--success-green) !important; font-weight: 700; }
        .deficit-text { color: #aaa; font-size: 0.85em; }

        .btn-save {
            width: fit-content; padding: 10px 20px; background: var(--success-green);
            color: white; border: none; border-radius: 6px; font-weight: 700;
            margin: 10px auto 25px auto; display: block; cursor: pointer; font-size: 0.75em; 
            text-transform: uppercase;
        }

        .multiselect-container { position: relative; }
        .multiselect-btn { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .multiselect-content {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1.2px solid var(--primary-black); z-index: 100; max-height: 180px; overflow-y: auto;
        }
        .multiselect-content label { display: flex; align-items: center; padding: 6px 8px; font-size: 0.7em; cursor: pointer; gap: 6px; border-bottom: 1px solid #f0f0f0; }
        .show { display: block; }

        @media screen and (max-width: 600px) {
            .container { width: 100%; max-width: 100%; border-radius: 0; }
            #capture-area { padding: 8px; width: auto; }
            select, .multiselect-btn { min-width: 75px; }
        }

        #pin-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 75%; max-width: 260px; text-align: center; }
        .modal-content input { width: 100%; padding: 8px; margin: 12px 0; border: 1.2px solid #ddd; border-radius: 5px; text-align: center; }
        .modal-content button { width: 100%; padding: 8px; background: var(--primary-black); color: #fff; border: none; border-radius: 5px; font-weight: 700; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--success-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="pin-modal">
        <div class="modal-content">
            <h3 style="font-size: 1rem; margin-bottom: 5px;">Akses Terbatas</h3>
            <p style="font-size: 0.7em; color: #666;">Masukkan PIN Keamanan</p>
            <input type="password" id="inputPinField" maxlength="8" placeholder="****">
            <button onclick="checkPin()">BUKA LAPORAN</button>
        </div>
    </div>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 8px; font-weight: 700; font-size: 0.65em;">MEMPROSES...</p>
    </div>

    <div class="container">
        <div id="capture-area">
            <div class="header-title">
                <h1>Pencapaian Omzet</h1>
                <div class="periode-label" id="periodeLabel">-</div>
            </div>

            <div id="filterSection" class="filter-group">
                <div class="filter-item">
                    <label>Tahun</label>
                    <select id="selTahun" onchange="renderLaporan()"></select>
                </div>
                <div class="filter-item">
                    <label>Bulan</label>
                    <select id="selBulan" onchange="renderLaporan()"></select>
                </div>
                <div class="filter-item">
                    <label>Kategori</label>
                    <div class="multiselect-container">
                        <div class="multiselect-btn" onclick="toggleKategori()">
                            <span id="btnTextKategori">Cek...</span>
                            <span>â–¼</span>
                        </div>
                        <div id="katContent" class="multiselect-content"></div>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Sales</th>
                            <th rowspan="2">Target</th>
                            <th rowspan="2">Jumlah</th>
                            <th rowspan="2">%</th>
                            <th colspan="3">Kekurangan</th>
                        </tr>
                        <tr>
                            <th>Ke 70%</th>
                            <th>Ke 80%</th>
                            <th>Ke 100%</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <button id="btnSaveJPG" class="btn-save" onclick="simpanLaporan()">
            Simpan
        </button>
    </div>

<script>
    const urlAPI = "https://script.google.com/macros/s/AKfycbzE1r4eDujFD3VZDG42jBKadPx2itFePElGyC-QoA6kU3m8RvTkfMAjTGIJ_ngNlwBA/exec"; 
    let masterPenjualan = [], masterTarget = [], correctPin = "", cachedData = null;
    const urutanBulan = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    async function init() {
        document.getElementById('loader-overlay').style.display = 'flex';
        try {
            const res = await fetch(urlAPI);
            const data = await res.json();
            cachedData = data; correctPin = data.pin;
            document.getElementById('pin-modal').style.display = 'flex';
        } catch (e) { alert("Gagal sinkronisasi."); }
        document.getElementById('loader-overlay').style.display = 'none';
    }

    function checkPin() {
        if (document.getElementById('inputPinField').value == correctPin) {
            masterPenjualan = cachedData.penjualan;
            masterTarget = cachedData.target;
            document.getElementById('pin-modal').style.display = 'none';
            populateFilters(); renderLaporan();
        } else { alert("PIN Salah!"); }
    }

    function toggleKategori() { document.getElementById("katContent").classList.toggle("show"); }

    function populateFilters() {
        const tahunSet = [...new Set(masterPenjualan.map(item => item.Tahun))].sort((a, b) => b - a);
        const bulanUnik = [...new Set(masterPenjualan.map(item => item.Bulan))];
        const bulanSorted = bulanUnik.sort((a, b) => urutanBulan.findIndex(m => a.includes(m)) - urutanBulan.findIndex(m => b.includes(m)));
        const kategoriSet = [...new Set(masterPenjualan.map(item => item.Kategori))].sort();

        const selTahun = document.getElementById('selTahun');
        const selBulan = document.getElementById('selBulan');
        const katContent = document.getElementById('katContent');

        selTahun.innerHTML = ""; selBulan.innerHTML = "";
        tahunSet.forEach(t => selTahun.innerHTML += `<option value="${t}">${t}</option>`);
        bulanSorted.forEach(b => selBulan.innerHTML += `<option value="${b}">${b}</option>`);
        
        katContent.innerHTML = "";
        kategoriSet.forEach(k => {
            const isDist = (k.toUpperCase() === "DISTRIBUSI");
            katContent.innerHTML += `<label><input type="checkbox" class="kat-check" value="${k}" ${isDist ? '' : 'checked'} ${isDist ? 'disabled' : ''} onchange="updateKatText(); renderLaporan();"> ${k}</label>`;
        });
        updateKatText();
    }

    function updateKatText() {
        const checked = document.querySelectorAll('.kat-check:checked');
        document.getElementById('btnTextKategori').innerText = checked.length + " Kat";
    }

    function formatRupiah(num) {
        if (!num || isNaN(num)) return "0";
        return Math.round(num).toLocaleString('id-ID');
    }

    function renderLaporan() {
        const thn = parseInt(document.getElementById('selTahun').value);
        const bln = document.getElementById('selBulan').value;
        const selectedKat = Array.from(document.querySelectorAll('.kat-check:checked')).map(c => c.value);
        document.getElementById('periodeLabel').innerText = `Periode: ${bln} ${thn}`;

        const salesMap = {};
        masterPenjualan.filter(d => d.Tahun == thn && d.Bulan == bln && selectedKat.includes(d.Kategori)).forEach(d => {
            salesMap[d.Sales] = (salesMap[d.Sales] || 0) + (parseFloat(d["Jumlah (Inc)"]) || 0);
        });

        const grouped = {};
        masterTarget.forEach(item => {
            const spv = item.Spv || "LAINNYA";
            if (!grouped[spv]) grouped[spv] = [];
            grouped[spv].push({ name: item.Sales, target: parseFloat(item.Target) || 0 });
        });

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        Object.keys(grouped).forEach((spv, idx) => {
            let tTgt = 0, tReal = 0;
            grouped[spv].forEach((m, sIdx) => {
                const real = salesMap[m.name] || 0;
                const tgt = m.target;
                tTgt += tgt; tReal += real;
                const pct = tgt > 0 ? Math.round((real / tgt) * 100) : 0;
                const rowClass = (sIdx === 0) ? 'first-in-group' : '';
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td style="text-align:left">${m.name}</td>
                        <td class="text-right">${formatRupiah(tgt)}</td>
                        <td class="text-right">${formatRupiah(real)}</td>
                        <td class="text-center ${pct >= 70 ? 'pct-achieved' : ''}">${pct}%</td>
                        <td class="text-right deficit-text">${real >= tgt*0.7 ? '-' : formatRupiah(tgt*0.7 - real)}</td>
                        <td class="text-right deficit-text">${real >= tgt*0.8 ? '-' : formatRupiah(tgt*0.8 - real)}</td>
                        <td class="text-right deficit-text">${real >= tgt ? '-' : formatRupiah(tgt - real)}</td>
                    </tr>`;
            });

            const tPct = tTgt > 0 ? Math.round((tReal / tTgt) * 100) : 0;
            tbody.innerHTML += `
                <tr class="spv-total-row">
                    <td style="text-align:left">${spv}</td>
                    <td class="text-right">${formatRupiah(tTgt)}</td>
                    <td class="text-right">${formatRupiah(tReal)}</td>
                    <td class="text-center">${tPct}%</td>
                    <td class="text-right">${tReal >= tTgt*0.7 ? '-' : formatRupiah(tTgt*0.7 - tReal)}</td>
                    <td class="text-right">${tReal >= tTgt*0.8 ? '-' : formatRupiah(tTgt*0.8 - tReal)}</td>
                    <td class="text-right">${tReal >= tTgt ? '-' : formatRupiah(tTgt - tReal)}</td>
                </tr>`;

            if (idx < Object.keys(grouped).length - 1) {
                tbody.innerHTML += `<tr class="spacer-row"><td colspan="7"></td></tr>`;
            }
        });
    }

    async function simpanLaporan() {
        const area = document.getElementById('capture-area');
        const filterSection = document.getElementById('filterSection');
        const btnSave = document.getElementById('btnSaveJPG');
        const overlay = document.getElementById('loader-overlay');
        const tableWrapper = document.querySelector('.table-wrapper');

        overlay.style.display = 'flex';
        btnSave.style.display = 'none';
        filterSection.style.display = 'none';

        const originalOverflow = tableWrapper.style.overflowX;
        tableWrapper.style.overflowX = 'visible';

        // Tunggu font selesai load
        await document.fonts.ready;
        await new Promise(resolve => setTimeout(resolve, 500));

        try {
            // Deteksi mobile dan adjust scale
            const isMobile = window.innerWidth <= 600;
            const scale = isMobile ? 1.5 : 2;
            
            const canvas = await html2canvas(area, {
                scale: scale,
                useCORS: true,
                allowTaint: true,
                backgroundColor: "#ffffff",
                logging: false,
                windowWidth: area.scrollWidth,
                windowHeight: area.scrollHeight,
                scrollY: -window.scrollY,
                scrollX: -window.scrollX,
                imageTimeout: 0,
                removeContainer: true,
                letterRendering: true,
                onclone: (clonedDoc) => {
                    const clonedArea = clonedDoc.getElementById('capture-area');
                    clonedArea.style.width = area.scrollWidth + 'px';
                    clonedArea.style.height = area.scrollHeight + 'px';
                    
                    // Force font rendering
                    const allText = clonedDoc.querySelectorAll('*');
                    allText.forEach(el => {
                        el.style.fontFamily = "'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif";
                    });
                }
            });

            const link = document.createElement('a');
            link.download = `Laporan_Omzet_${Date.now()}.jpg`;
            link.href = canvas.toDataURL("image/jpeg", 0.95);
            link.click();

            setTimeout(() => alert("Berhasil disimpan ke galeri"), 400);
        } catch (e) {
            console.error(e);
            alert("GAGAL PROSES: " + e.message);
        } finally {
            tableWrapper.style.overflowX = originalOverflow;
            btnSave.style.display = 'block';
            filterSection.style.display = 'flex';
            overlay.style.display = 'none';
        }
    }
    init();
</script>
</body>
</html>
