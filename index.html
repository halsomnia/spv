<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORM OPEN BLOCK - PT. NUSA SARANA INDONESIA</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Mengubah semua font menjadi DM Sans */
        body { font-family: 'DM Sans', sans-serif; margin: 0; padding: 30px; background-color: #f4f4f4; }
        .container { width: 800px; margin: 0 auto; background-color: white; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .logo { font-size: 20px; font-weight: bold; color: #004d99; display: flex; align-items: center; }
        .doc-info { text-align: right; font-size: 14px; font-weight: bold; }
        h1 { text-align: center; font-size: 18px; margin-top: 5px; margin-bottom: 30px; }
        .info-section { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .info-row { 
            display: flex; 
            align-items: center; 
        }
        .info-section label { 
            width: 180px; 
            font-weight: normal; 
            white-space: nowrap; 
            flex-shrink: 0; 
        }
        .info-section .separator { 
            margin: 0 10px; 
            width: 10px; 
            text-align: center; 
            flex-shrink: 0; 
        }
        .info-section select, .info-section input { 
            flex-grow: 1; 
            padding: 4px; 
            border: 1px solid #ccc; 
            font-family: 'DM Sans', sans-serif;
            transition: border-color 0.3s;
        }
        .piutang-table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 30px; }
        .piutang-table th, .piutang-table td { border: 1px solid #000; padding: 8px 10px; text-align: center; font-size: 13px; height: 25px; }
        .piutang-table th { background-color: #e0e0e0; font-weight: bold; }
        .piutang-table .total-row td { font-weight: bold; text-align: center; background-color: #e0e0e0; padding: 8px 10px; }
        .data-nominal { text-align: right !important; }
        .area-section { margin-bottom: 25px; border: 1px solid #000; }
        .area-section h3 { font-size: 14px; padding: 8px 10px; margin: 0; background-color: #e0e0e0; border-bottom: 1px solid #000; }
        .area-box { 
            height: 80px; 
            padding: 10px; 
            resize: vertical; 
            border: none; 
            width: 100%; 
            box-sizing: border-box; 
            font-family: 'DM Sans', sans-serif;
        }
        .closing { margin-top: 40px; font-size: 14px; text-align: justify; }
        
        .footer-actions {
            margin-top: 20px;
            text-align: left;
        }
        .print-button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .print-button:hover {
            background-color: #1e7e34;
        }

        .error-border {
            border: 2px solid red !important;
        }
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

    <div class="container" id="formContainer">
        <div class="header">
            <div class="logo">PT. NUSA SARANA INDONESIA</div>
            <div class="doc-info">NSI-F-MKT-002</div>
        </div>
        
        <h1>FORM OPEN BLOCK</h1>

        <p style="font-size: 14px;">Permohonan open block order, dengan ini kami lampirkan data toko:</p>

        <div class="info-section">
            <div class="info-row"><label>No Pelanggan</label><span class="separator">:</span><input type="text" id="noPelanggan" readonly style="background-color: #f0f0f0;"></div>
            <div class="info-row"><label>Nama Pelanggan</label><span class="separator">:</span>
                <input type="text" list="daftarPelanggan" id="namaPelangganInput" placeholder="Ketik atau pilih nama pelanggan..." autocomplete="off">
            </div>
            <div class="info-row"><label>Rata-rata Pembayaran</label><span class="separator">:</span><input type="text" id="rataPembayaran"></div>

            <div class="info-row"><label>Cara Pembayaran</label><span class="separator">:</span>
                <select id="caraPembayaran">
                    <option value="">-- Pilih Cara Pembayaran --</option>
                    <option value="CASH">CASH</option>
                    <option value="TRANSFER">TRANSFER</option>
                    <option value="GIRO">GIRO</option>
                </select>
            </div>
            <div class="info-row"><label>Pengajuan</label><span class="separator">:</span>
                <select id="pengajuan">
                    <option value="">-- Pilih Jenis Pengajuan --</option>
                    <option value="OVERDUE">OVERDUE</option>
                    <option value="OVERLIMIT">OVERLIMIT</option>
                </select>
            </div>
            <div class="info-row"><label>Alasan Pengajuan</label><span class="separator">:</span><input type="text" id="alasanPengajuan"></div>

            <div class="info-row"><label>Plafon Order</label><span class="separator">:</span><input type="text" id="plafonOrder"></div>
            <div class="info-row"><label>Rencana Order</label><span class="separator">:</span><input type="text" id="rencanaOrder" placeholder="Masukkan angka tanpa titik atau koma"></div>
            <div class="info-row"><label>Rencana Pembayaran</label><span class="separator">:</span><input type="text" id="rencanaPembayaran"></div>
        </div>

        <h3 style="margin-top: 25px; font-size: 14px;">Data Piutang toko:</h3>
        <table class="piutang-table">
            <thead>
                <tr>
                    <th style="width: 10%;">No Faktur</th>
                    <th style="width: 10%;">Tgl Faktur</th>
                    <th style="width: 15%;">Umur Piutang</th>
                    <th style="width: 20%;">Nominal</th>
                    <th style="width: 15%;">Outstanding</th>
                    <th style="width: 15%;">TOP</th>
                    <th style="width: 15%;">Jatuh Tempo</th>
                </tr>
            </thead>
            <tbody>
                <tr><td></td><td></td><td>1-30</td><td id="nominal-1-30" class="data-nominal"></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td>30-60</td><td id="nominal-30-60" class="data-nominal"></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td>61-90</td><td id="nominal-61-90" class="data-nominal"></td><td></td><td></td><td></td></tr>
                <tr><td></td><td></td><td>>120</td><td id="nominal-over-120" class="data-nominal"></td><td></td><td></td><td></td></tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" style="text-align: right; padding-right: 15px;">Total</td>
                    <td id="totalNominal" class="data-nominal">-</td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </table>

        <div class="area-section">
            <h3>Rekomendasi dari Tim Piutang</h3>
            <textarea class="area-box" placeholder="Tulis rekomendasi di sini..."></textarea>
        </div>

        <div class="area-section">
            <h3>Persetujuan dari Area Sales Manager (ASM)</h3>
            <textarea class="area-box" placeholder="Tulis persetujuan atau catatan di sini..."></textarea>
        </div>
        
        <div class="closing">
            <p style="margin-bottom: 10px;">
                Demikian permohonan ini kami ajukan, mohon persetujuannya. Terima kasih.
            </p>
            <p style="font-size: 14px; margin-top: 10px;">
                <em id="tanggalPengajuan">Pengajuan ini dibuat dan dari data per tanggal ...</em>
            </p>
        </div>
    </div>

    <div class="footer-actions">
        <button class="print-button" onclick="saveAsJpg()">Simpan JPG</button>
    </div>

    <datalist id="daftarPelanggan"></datalist>

    <script>
        const pelangganCSV = 'data.csv';
        const inputPelanggan = document.getElementById('namaPelangganInput');
        const noPelangganInput = document.getElementById('noPelanggan');
        const datalist = document.getElementById('daftarPelanggan');
        const rencanaOrderInput = document.getElementById('rencanaOrder');
        const rencanaPembayaranInput = document.getElementById('rencanaPembayaran');
        const caraPembayaranSelect = document.getElementById('caraPembayaran');
        const pengajuanSelect = document.getElementById('pengajuan');
        const tanggalPengajuanElement = document.getElementById('tanggalPengajuan');
        let allPiutangData = [];
        let allPelangganNames = [];
        let nameToNoPelanggan = {};

        function formatRupiah(number) {
            let num = parseFloat(number);
            if (isNaN(num)) return '-';
            return Math.round(num).toLocaleString('id-ID');
        }

        function formatRencanaOrder() {
            let value = rencanaOrderInput.value.replace(/\D/g, '');
            if (value === '') {
                rencanaOrderInput.value = '';
                return;
            }
            let formatted = parseInt(value).toLocaleString('id-ID');
            rencanaOrderInput.value = formatted;
        }

        rencanaOrderInput.addEventListener('input', formatRencanaOrder);
        rencanaOrderInput.addEventListener('blur', () => {
            if (rencanaOrderInput.value !== '') {
                if (!rencanaOrderInput.value.startsWith('Rp ')) {
                    rencanaOrderInput.value = 'Rp ' + rencanaOrderInput.value;
                }
            }
        });
        rencanaOrderInput.addEventListener('focus', () => {
            if (rencanaOrderInput.value.startsWith('Rp ')) {
                rencanaOrderInput.value = rencanaOrderInput.value.replace('Rp ', '').replace(/\./g, '');
            }
            formatRencanaOrder();
        });

        // --- VALIDASI DAN FUNGSI SIMPAN JPG BARU ---
        
        function clearErrorBorders() {
            [inputPelanggan, rencanaOrderInput, rencanaPembayaranInput, caraPembayaranSelect, pengajuanSelect].forEach(el => {
                el.classList.remove('error-border');
            });
        }

        function saveAsJpg() {
            clearErrorBorders(); 
            const container = document.getElementById('formContainer');
            let incomplete = false;

            // 1. Tentukan field yang wajib diisi
            const requiredFields = [
                { element: inputPelanggan, name: 'Nama Pelanggan' },
                { element: rencanaOrderInput, name: 'Rencana Order' },
                { element: rencanaPembayaranInput, name: 'Rencana Pembayaran' },
                { element: caraPembayaranSelect, name: 'Cara Pembayaran' },
                { element: pengajuanSelect, name: 'Pengajuan' }
            ];

            // 2. Lakukan validasi
            requiredFields.forEach(field => {
                const value = field.element.value.trim();
                // Khusus untuk rencanaOrderInput, cek nilai setelah format ribuan dihapus saat fokus
                if (field.element === rencanaOrderInput) {
                     // Check if it's empty or only contains 'Rp '
                     if (value === '' || value === 'Rp') {
                        field.element.classList.add('error-border');
                        incomplete = true;
                    }
                } else if (value === '' || value === '-- Pilih Cara Pembayaran --' || value === '-- Pilih Jenis Pengajuan --') {
                    field.element.classList.add('error-border');
                    incomplete = true;
                }
            });

            // 3. Hentikan jika data belum lengkap
            if (incomplete) {
                alert('Data Belum Lengkap! Mohon lengkapi kolom yang bergaris merah.');
                return; 
            }

            // 4. Proses Simpan JPG (html2canvas)
            
            // Simpan nilai asli dan ganti dengan span untuk screenshot yang bersih
            const originalNoPelanggan = noPelangganInput.value;
            const originalInputNames = inputPelanggan.value;
            const originalRencanaOrder = rencanaOrderInput.value;
            const originalRencanaPembayaran = rencanaPembayaranInput.value;
            const originalCaraPembayaran = caraPembayaranSelect.value;
            const originalPengajuan = pengajuanSelect.value;

            const fieldsToReplace = [
                { input: noPelangganInput, value: originalNoPelanggan },
                { input: inputPelanggan, value: originalInputNames },
                { input: rencanaOrderInput, value: originalRencanaOrder },
                { input: rencanaPembayaranInput, value: originalRencanaPembayaran }
            ];
            const selectToReplace = [
                { select: caraPembayaranSelect, value: originalCaraPembayaran },
                { select: pengajuanSelect, value: originalPengajuan }
            ];
            
            let replacedElements = [];
            
            // Ganti input dan select dengan span polos (menghilangkan garis)
            [...fieldsToReplace, ...selectToReplace.map(item => ({input: item.select, value: item.value}))].forEach(item => {
                const span = document.createElement('span');
                span.textContent = item.value;
                span.style.padding = '4px 0'; /* Padding vertikal yang sama dengan input */
                span.style.display = 'inline-block';
                span.style.minWidth = '100px';

                const parent = item.input.parentNode;
                parent.replaceChild(span, item.input);
                replacedElements.push({ original: item.input, replacement: span, parent: parent });
            });

            // Sembunyikan tombol
            const footerActions = document.querySelector('.footer-actions');
            footerActions.style.display = 'none';

            // html2canvas untuk mengambil screenshot
            html2canvas(container, {
                scale: 2, 
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // Kembalikan elemen input/select
                replacedElements.forEach(item => {
                    item.parent.replaceChild(item.original, item.replacement);
                });

                // Kembalikan tombol
                footerActions.style.display = 'block';

                // Simpan gambar
                const image = canvas.toDataURL('image/jpeg', 0.9); 
                const link = document.createElement('a');
                link.href = image;
                
                let filename = `FORM_OPEN_BLOCK_${nameToNoPelanggan[originalInputNames] || 'TANPA_NO'}_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.jpg`;
                link.download = filename;
                link.click();
                
                // Tampilkan Pop-up Konfirmasi
                alert('File tersimpan ke galeri Anda.');

            }).catch(error => {
                console.error("Error generating image:", error);
                alert('Gagal membuat file JPG. Silakan coba lagi.');
                
                // Pastikan elemen kembali ke normal jika terjadi error
                replacedElements.forEach(item => {
                    if (item.replacement.parentNode) item.parent.replaceChild(item.original, item.replacement);
                });
                footerActions.style.display = 'block';
            });
        }
        
        // --- DATA LOADING DAN FUNGSI LAINNYA ---
        
        async function loadPiutangData() {
            try {
                const response = await fetch(pelangganCSV);
                if (!response.ok) throw new Error(`Gagal memuat file: ${response.statusText}`);
                const csvText = await response.text();

                const rows = csvText.trim().split('\n');
                const dataRows = rows.slice(1);

                const uniqueNames = new Set();

                dataRows.forEach(row => {
                    const columns = row.split(';');
                    if (columns.length < 4) return;

                    let nama = columns[0].trim().replace(/"/g, '');
                    let umur = columns[1].trim();
                    let noPel = columns[3].trim().replace(/"/g, '');
                    const nominalStr = columns[2].trim().replace(/,/g, '.');
                    const nominal = parseFloat(nominalStr);

                    if (nama && !isNaN(nominal)) {
                        if (umur.startsWith('>')) umur = '>' + umur.slice(1).trim();
                        allPiutangData.push({ nama, umur, nominal });

                        uniqueNames.add(nama);

                        if (!nameToNoPelanggan[nama] && noPel) {
                            nameToNoPelanggan[nama] = noPel;
                        }
                    }
                });

                allPelangganNames = [...uniqueNames].sort();

                datalist.innerHTML = '';
                allPelangganNames.forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    datalist.appendChild(option);
                });

            } catch (error) {
                console.error("Error:", error);
            }
        }

        function handleInput() {
            const value = inputPelanggan.value.trim();

            if (value && nameToNoPelanggan[value]) {
                noPelangganInput.value = nameToNoPelanggan[value];
            } else {
                noPelangganInput.value = '';
            }

            if (allPelangganNames.includes(value)) {
                updatePiutangTable(value);
            } else {
                updatePiutangTable('');
            }
        }

        function updatePiutangTable(namaPelanggan) {
            document.getElementById('totalNominal').textContent = '-';
            document.getElementById('nominal-1-30').textContent = '';
            document.getElementById('nominal-30-60').textContent = '';
            document.getElementById('nominal-61-90').textContent = '';
            document.getElementById('nominal-over-120').textContent = '';

            if (!namaPelanggan) return;

            const filteredData = allPiutangData.filter(item => item.nama === namaPelanggan);

            const piutangByCategory = {
                '1-30': 0,
                '30-60': 0,
                '61-90': 0,
                '>120': 0
            };

            let totalPiutang = 0;

            filteredData.forEach(item => {
                totalPiutang += item.nominal;
                if (item.umur in piutangByCategory) {
                    piutangByCategory[item.umur] += item.nominal;
                }
            });

            document.getElementById('nominal-1-30').textContent = formatRupiah(piutangByCategory['1-30']);
            document.getElementById('nominal-30-60').textContent = formatRupiah(piutangByCategory['30-60']);
            document.getElementById('nominal-61-90').textContent = formatRupiah(piutangByCategory['61-90']);
            document.getElementById('nominal-over-120').textContent = formatRupiah(piutangByCategory['>120']);
            document.getElementById('totalNominal').textContent = formatRupiah(totalPiutang);
        }

        function setTodayDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = today.toLocaleDateString('id-ID', options);
            tanggalPengajuanElement.innerHTML = `<em>Pengajuan ini dibuat dan dari data per tanggal ${formattedDate}</em>`;
        }

        inputPelanggan.addEventListener('input', handleInput);
        inputPelanggan.addEventListener('change', handleInput);

        loadPiutangData();
        setTodayDate();
    </script>

</body>
</html>
